// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(uuid())
  // Email/password auth: phone is optional (kept for legacy + future SMS/OTP).
  phone         String?  @unique
  email         String?  @unique
  passwordHash  String?
  name          String?
  languagePref  String   @default("en")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  businesses         Business[]
  subscriptions      Subscription[]
  devices            Device[]
  auditLogs          AuditLog[] @relation("ActorUser")
  filingPacks        FilingPack[]
  transactionOverrides TransactionOverride[]
  otpChallenges      OtpChallenge[]
  businessMembers    BusinessMember[]

  @@map("users")
}

model Business {
  id                    String   @id @default(uuid())
  ownerUserId           String
  name                  String
  legalForm             String
  sector                String?
  state                 String?
  cacNumber             String?
  tin                   String?
  vatRegistered         Boolean  @default(false)
  estimatedTurnoverBand String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  owner                 User            @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  taxProfiles           TaxProfile[]
  transactions          Transaction[]
  documents             Document[]
  obligations           Obligation[]
  alerts                Alert[]
  subscriptions         Subscription[]
  invoices              Invoice[]
  importBatches         ImportBatch[]
  filingPacks           FilingPack[]
  notificationSetting   NotificationSetting?
  actionStates          ActionState[]
  bankConnections       BankConnection[]
  auditEvents           AuditEvent[]
  bankConsents          BankConsent[]
  complianceTasks       ComplianceTask[]
  filingRuns            FilingRun[]
  notificationPreferences NotificationPreference[]
  notificationEvents    NotificationEvent[]
  obligationSnapshots   ObligationSnapshot[]
  transactionOverrides  TransactionOverride[]
  reviewIssues          ReviewIssue[]
  members              BusinessMember[]
  paymentEvents         PaymentEvent[]

  @@map("businesses")
}

model TaxProfile {
  id                 String   @id @default(uuid())
  businessId         String
  taxYear            Int
  citStatus          String
  vatStatus          String
  whtStatus          String
  eligibilityDetailJson Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  business           Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, taxYear])
  @@map("tax_profiles")
}

model TaxRule {
  id                String   @id @default(uuid())
  taxType           String
  year              Int
  thresholdMin      Decimal? @db.Decimal(15, 2)
  thresholdMax      Decimal? @db.Decimal(15, 2)
  conditionExpression String?
  resultJson        Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([taxType, year, thresholdMin, thresholdMax])
  @@map("tax_rules")
}

model TransactionCategory {
  id          String   @id @default(uuid())
  name        String
  type        String   // income or expense
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())

  transactions Transaction[]
  aiSuggestions Transaction[] @relation("AICategory")
  transactionOverrides TransactionOverride[]

  @@map("transaction_categories")
}

model Transaction {
  id              String   @id @default(uuid())
  businessId      String
  type            String   // income or expense
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("NGN")
  date            DateTime
  description     String?
  source          String   @default("manual") // manual, upload, import
  classification  String   @default("unknown") // 'business'|'personal'|'unknown'
  categoryId      String?
  categoryConfidence Decimal? @db.Decimal(5, 4)
  aiCategoryId    String?
  aiConfidence    Decimal? @db.Decimal(5, 4)
  isBusinessFlag  Boolean  @default(true)
  invoiceId       String?
  importFingerprint String? @unique
  importBatchId   String?
  provider        String?  // "mono", null
  providerTxnId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category        TransactionCategory? @relation(fields: [categoryId], references: [id])
  aiCategory      TransactionCategory? @relation("AICategory", fields: [aiCategoryId], references: [id])
  documents       Document[]
  invoice         Invoice? @relation(fields: [invoiceId], references: [id])
  importBatch     ImportBatch? @relation(fields: [importBatchId], references: [id], onDelete: SetNull)
  override        TransactionOverride?

  @@unique([businessId, provider, providerTxnId], name: "transactions_business_provider_txnId_key")
  @@index([businessId, date])
  @@index([businessId, classification])
  @@index([businessId, type])
  @@index([businessId, categoryId])
  @@index([providerTxnId])
  @@map("transactions")
}

model TransactionOverride {
  id             String   @id @default(uuid())
  businessId     String
  transactionId  String   @unique
  setByUserId    String
  classification String?  // optional override
  categoryId     String?  // optional override
  note           String?  @db.Text
  createdAt      DateTime @default(now())

  business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  setByUser      User @relation(fields: [setByUserId], references: [id], onDelete: Restrict)
  category       TransactionCategory? @relation(fields: [categoryId], references: [id])

  @@index([businessId, createdAt])
  @@map("transaction_overrides")
}

model ReviewIssue {
  id          String   @id @default(uuid())
  businessId  String
  taxYear     Int
  type        String   // 'uncategorized'|'unknown_classification'|'missing_month'|'missing_evidence'|'possible_duplicate'
  severity    String   // 'low'|'medium'|'high'
  status      String   @default("open") // 'open'|'dismissed'|'resolved'
  dedupeKey   String
  title       String
  description String   @db.Text
  entityType  String?
  entityId    String?
  metaJson    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, taxYear, type, dedupeKey])
  @@index([businessId, taxYear, status])
  @@index([type, status])
  @@map("review_issues")
}

model Document {
  id                    String   @id @default(uuid())
  businessId            String
  relatedTransactionId  String?
  type                  String   // receipt, bank_statement, other
  storageUrl            String
  mimeType              String
  size                  Int
  ocrStatus             String   @default("pending") // pending, success, failed
  extractedMetadataJson Json?
  createdAt             DateTime @default(now())

  business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  transaction           Transaction? @relation(fields: [relatedTransactionId], references: [id], onDelete: SetNull)
  importBatches         ImportBatch[]
  taskEvidenceLinks     TaskEvidenceLink[]
  filingPackPDFs        FilingPack[] @relation("FilingPackPDF")
  filingPackCSVs        FilingPack[] @relation("FilingPackCSV")
  filingPackZIPs        FilingPack[] @relation("FilingPackZIP")

  @@map("documents")
}

model Obligation {
  id          String   @id @default(uuid())
  businessId  String
  taxType     String   // CIT, VAT, WHT
  periodStart DateTime
  periodEnd   DateTime
  dueDate     DateTime
  status      String   @default("upcoming") // upcoming, due, overdue, fulfilled
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  alerts      Alert[]

  @@index([businessId, dueDate])
  @@map("obligations")
}

model Alert {
  id                String   @id @default(uuid())
  businessId        String
  type              String   // deadline_threshold, turnover_threshold, missing_receipt, etc.
  messageKey        String
  severity          String   @default("info") // info, warn, critical
  linkedObligationId String?
  payloadJson       Json?
  createdAt         DateTime @default(now())
  readAt            DateTime?

  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  obligation        Obligation? @relation(fields: [linkedObligationId], references: [id], onDelete: SetNull)

  @@index([businessId, createdAt])
  @@index([businessId, readAt])
  @@map("alerts")
}

model NotificationSetting {
  businessId        String   @id
  deadlineDueSoon   Boolean  @default(true)
  deadlineVerySoon  Boolean  @default(true)
  monthlyReminder   Boolean  @default(true)
  missingReceipts   Boolean  @default(true)

  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

model KnowledgeArticle {
  id            String   @id @default(uuid())
  slug          String
  language      String   // en, pidgin
  title         String
  contentMarkdown String @db.Text
  tags          String[]
  version       Int      @default(1)
  publishedAt   DateTime?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([slug, language])
  @@map("knowledge_articles")
}

model Device {
  id        String   @id @default(uuid())
  userId    String
  platform  String   // android, ios
  pushToken String?
  lastSeenAt DateTime @default(now())
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("devices")
}

model AuditLog {
  id            String   @id @default(uuid())
  actorUserId   String?
  resourceType  String
  resourceId    String
  action        String
  beforeJson    Json?
  afterJson     Json?
  createdAt     DateTime @default(now())

  actor         User?    @relation("ActorUser", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([resourceType, resourceId])
  @@index([actorUserId])
  @@map("audit_logs")
}

model Plan {
  id          String   @id @default(uuid())
  planKey     String?  @unique // 'free'|'basic'|'business'|'accountant'
  name        String
  description String?
  monthlyPrice Decimal  @db.Decimal(10, 2)
  annualPrice Decimal? @db.Decimal(10, 2)
  currency    String   @default("NGN")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  features    PlanFeature[]
  subscriptions Subscription[]

  @@map("plans")
}

model FilingPack {
  id                String   @id @default(uuid())
  businessId        String
  taxYear           Int
  status            String   @default("queued") // queued, generating, ready, failed
  version           Int      @default(1)
  requestedByUserId  String
  requestedAt       DateTime @default(now())
  completedAt       DateTime?
  errorMessage      String?
  summaryJson       Json?
  pdfDocumentId     String?
  csvDocumentId     String?
  zipDocumentId     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  requestedBy       User     @relation(fields: [requestedByUserId], references: [id], onDelete: Restrict)
  pdfDocument       Document? @relation("FilingPackPDF", fields: [pdfDocumentId], references: [id], onDelete: SetNull)
  csvDocument       Document? @relation("FilingPackCSV", fields: [csvDocumentId], references: [id], onDelete: SetNull)
  zipDocument       Document? @relation("FilingPackZIP", fields: [zipDocumentId], references: [id], onDelete: SetNull)
  items             FilingPackItem[]

  @@unique([businessId, taxYear, version])
  @@index([businessId, taxYear])
  @@index([status])
  @@map("filing_packs")
}

model FilingPackItem {
  id          String   @id @default(uuid())
  filingPackId String
  kind        String   // transaction, document, summary
  refId       String   // transactionId or documentId
  metaJson    Json?
  createdAt   DateTime @default(now())

  filingPack  FilingPack @relation(fields: [filingPackId], references: [id], onDelete: Cascade)

  @@index([filingPackId])
  @@map("filing_pack_items")
}

model PlanFeature {
  id         String   @id @default(uuid())
  planId     String
  featureKey String
  limitValue Int?
  createdAt  DateTime @default(now())

  plan       Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, featureKey])
  @@map("plan_features")
}

model Subscription {
  id                    String   @id @default(uuid())
  userId                String
  businessId            String
  planId                String
  status                String   @default("active") // active, past_due, canceled, trialing
  provider              String?  // 'paystack' or null for free/local
  providerCustomerId    String?
  providerSubscriptionId String?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)
  startedAt             DateTime @default(now())
  endsAt                DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business  Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  plan      Plan     @relation(fields: [planId], references: [id])

  @@unique([businessId]) // One active subscription per business
  @@index([userId, businessId])
  @@index([providerSubscriptionId])
  @@map("subscriptions")
}

model Invoice {
  id            String   @id @default(uuid())
  businessId    String
  invoiceNumber String
  issueDate     DateTime
  dueDate       DateTime?
  customerName  String?
  customerContact String?
  status        String   @default("draft") // draft, sent, paid, cancelled
  totalAmount   Decimal  @db.Decimal(15, 2)
  currency      String   @default("NGN")
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items         InvoiceItem[]
  transactions  Transaction[]

  @@index([businessId, invoiceNumber])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model ImportBatch {
  id        String   @id @default(uuid())
  businessId String
  documentId String?
  source    String   @default("statement") // statement, bank_connect
  status    String   @default("pending") // pending, parsed, pending_review, approved, rolled_back, failed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business  Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  document  Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)
  lines     ImportBatchLine[]
  transactions Transaction[]

  @@index([documentId])
  @@index([businessId, status])

  @@map("import_batches")
}

model ImportBatchLine {
  id                  String   @id @default(uuid())
  importBatchId       String
  date                DateTime
  description         String?
  amount              Decimal  @db.Decimal(15, 2)
  direction           String   // credit, debit
  suggestedCategoryId String?
  aiConfidence        Decimal? @db.Decimal(5, 4)
  mappedTransactionId String?

  importBatch         ImportBatch @relation(fields: [importBatchId], references: [id], onDelete: Cascade)

  @@map("import_batch_lines")
}

model ActionState {
  id          String   @id @default(uuid())
  businessId  String
  actionType  String
  taxYear     Int
  status      String   @default("open") // open, completed, dismissed
  dismissedAt DateTime?
  completedAt DateTime?
  metaJson    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, actionType, taxYear])
  @@index([businessId, taxYear, status])
  @@map("action_states")
}

model BankConnection {
  id                String   @id @default(uuid())
  businessId        String
  provider          String   // "mono", "okra", "stitch", etc.
  status            String   @default("active") // active, error, disconnected
  providerAccountId String
  providerTokenCiphertext String?
  providerTokenIv         String?
  institutionName   String?
  accountName       String?
  accountNumberMasked String?
  currency          String   @default("NGN")
  lastSyncedAt      DateTime?
  lastSyncCursor    String?
  lastSyncRequestedAt DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  importEvents      BankImportEvent[]
  consents          BankConsent[]

  @@unique([businessId, provider, providerAccountId])
  @@index([businessId])
  @@index([status])
  @@map("bank_connections")
}

model BankImportEvent {
  id              String   @id @default(uuid())
  bankConnectionId String
  type            String   // sync_started, sync_success, sync_failed
  payloadJson     Json?
  createdAt       DateTime @default(now())

  bankConnection  BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)

  @@index([bankConnectionId, createdAt])
  @@map("bank_import_events")
}

model AuditEvent {
  id          String   @id @default(uuid())
  businessId  String?
  actorUserId String?
  action      String   // bank.connect, bank.sync.start, bank.sync.success, bank.sync.fail, bank.disconnect, import.create, import.approve, import.rollback, export.create, plan.change
  entityType  String   // BankConnection, ImportBatch, FilingPack, etc.
  entityId    String
  ip          String?
  userAgent   String?
  metaJson    Json?
  createdAt   DateTime @default(now())

  business    Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_events")
}

model OtpChallenge {
  id          String   @id @default(uuid())
  userId      String?
  phone       String
  codeHash    String
  expiresAt   DateTime
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  consumedAt  DateTime?
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([phone, expiresAt])
  @@map("otp_challenges")
}

model BusinessMember {
  id         String   @id @default(uuid())
  businessId String
  userId     String
  role       String   @default("member") // 'owner'|'member'|'accountant'
  createdAt  DateTime @default(now())

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
  @@index([userId])
  @@index([businessId, role])
  @@map("business_members")
}

model BankConsent {
  id                String   @id @default(uuid())
  businessId        String
  bankConnectionId  String
  provider          String   // "mono"
  scope             Json     // { statements: true, balances: false, periodDays: 90 }
  consentTextVersion String
  acceptedAt        DateTime
  acceptedByUserId  String
  revokedAt         DateTime?
  revokedByUserId   String?
  createdAt         DateTime @default(now())

  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bankConnection    BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)

  @@index([bankConnectionId])
  @@index([businessId])
  @@map("bank_consents")
}

model ComplianceTask {
  id                String   @id @default(uuid())
  businessId        String
  taxYear           Int
  taskKey           String
  title             String
  description       String
  category          String   // registration, filing, records, payment, other
  frequency         String   // one_time, monthly, quarterly, annual
  dueDate           DateTime
  status            String   @default("open") // open, in_progress, done, overdue, dismissed
  priority          Int      @default(50)
  evidenceRequired  Boolean  @default(false)
  evidenceSpecJson  Json?
  sourceRuleSet     String
  createdBy         String   // 'system' or userId
  completedAt       DateTime?
  dismissedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  evidenceLinks     TaskEvidenceLink[]

  @@unique([businessId, taxYear, taskKey])
  @@index([businessId, dueDate])
  @@index([businessId, status])
  @@map("compliance_tasks")
}

model TaskEvidenceLink {
  id          String   @id @default(uuid())
  taskId      String
  documentId  String
  note        String?
  createdAt   DateTime @default(now())

  task        ComplianceTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([documentId])
  @@map("task_evidence_links")
}

model FilingRun {
  id            String   @id @default(uuid())
  businessId    String
  taxYear       Int
  kind          String   // 'annual_return_prep'
  status        String   @default("in_progress") // 'in_progress'|'ready'|'submitted'|'abandoned'
  currentStep   String   @default("confirm_business") // 'confirm_business'|'income'|'expenses'|'evidence'|'review'
  answersJson   Json     @default("{}")
  computedJson  Json?
  lastViewedAt DateTime @default(now())
  createdByUserId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, taxYear, kind])
  @@index([businessId, taxYear])
  @@map("filing_runs")
}

model NotificationPreference {
  id          String   @id @default(uuid())
  businessId  String
  userId      String
  channel     String   // 'in_app'|'email'|'sms'
  enabled     Boolean  @default(true)
  rulesJson   Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId, channel])
  @@index([businessId, userId])
  @@map("notification_preferences")
}

model NotificationEvent {
  id            String   @id @default(uuid())
  businessId    String
  userId        String?
  type          String   // 'deadline_reminder'|'task_overdue'|'accountant_request'|'filing_pack_ready'
  channel       String   // 'in_app'|'email'|'sms'
  status        String   @default("queued") // 'queued'|'sent'|'failed'|'skipped'
  provider      String?  // 'resend'|'termii'|'twilio'|...
  to            String?  // email/phone
  subject       String?
  bodyPreview   String?
  metaJson      Json?
  errorMessage  String?
  sentAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, createdAt])
  @@index([status, createdAt])
  @@map("notification_events")
}

model TaxRuleSet {
  id            String   @id @default(uuid())
  version       String   @unique
  name          String
  status        String   @default("draft") // 'draft'|'active'|'archived'
  effectiveFrom DateTime
  effectiveTo   DateTime?
  description   String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  rules         TaxRuleV2[]
  deadlineTemplates DeadlineTemplate[]

  @@index([status])
  @@map("tax_rule_sets")
}

model TaxRuleV2 {
  id              String   @id @default(uuid())
  ruleSetId       String
  key             String
  type            String   // 'eligibility'|'obligation'|'deadline'|'threshold'
  priority        Int
  conditionsJson  Json
  outcomeJson     Json
  explanation     String   @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ruleSet         TaxRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@unique([ruleSetId, key])
  @@index([ruleSetId, priority])
  @@map("tax_rules_v2")
}

model ObligationSnapshot {
  id              String   @id @default(uuid())
  businessId      String
  ruleSetVersion  String
  evaluatedAt     DateTime @default(now())
  inputsJson      Json
  outputsJson     Json
  explanationJson Json
  createdAt       DateTime @default(now())

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, evaluatedAt])
  @@map("obligation_snapshots")
}

model DeadlineTemplate {
  id              String   @id @default(uuid())
  ruleSetId       String
  key             String
  frequency       String   // 'monthly'|'quarterly'|'annual'|'one_time'
  dueDayOfMonth   Int?
  dueMonth        Int?
  dueDay          Int?
  offsetDays      Int?
  appliesWhenJson Json?
  title           String
  description     String   @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ruleSet         TaxRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@unique([ruleSetId, key])
  @@map("deadline_templates")
}

model PaymentEvent {
  id            String   @id @default(uuid())
  provider      String   // 'paystack'
  eventType     String   // 'charge.success', 'subscription.create', 'subscription.disable', etc.
  eventId       String?  @unique // Provider's event ID for idempotency
  payloadJson   Json
  receivedAt    DateTime @default(now())
  processedAt   DateTime?
  status        String   @default("pending") // pending, processed, failed
  errorMessage  String?
  businessId    String?
  subscriptionId String?

  business      Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([provider, eventType])
  @@index([status, receivedAt])
  @@index([businessId])
  @@map("payment_events")
}

